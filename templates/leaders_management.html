{% extends "base.html" %} {% block content %}
<!-- Header -->
<div class="text-center mb-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-2">Leaders Management</h1>
  <p class="text-gray-600">
    Manage cell group leaders and their contact information
  </p>
</div>

<!-- Add Leader Button -->
<div class="mb-6 flex justify-between items-center">
  <div class="flex space-x-4">
    <button
      onclick="showAddLeaderForm()"
      class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center"
    >
      <i class="fas fa-plus mr-2"></i>
      Add New Leader
    </button>
    <button
      onclick="loadLeaders()"
      class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center"
    >
      <i class="fas fa-refresh mr-2"></i>
      Refresh
    </button>
  </div>

  <!-- Zone Filter -->
  <div>
    <select
      id="zoneFilter"
      onchange="loadLeaders()"
      class="px-4 py-2 border border-gray-300 rounded-lg"
    >
      <option value="">All Zones</option>
      <!-- Zones will be populated by JavaScript -->
    </select>
  </div>
</div>

<!-- Leaders Table -->
<div class="bg-white rounded-lg shadow-md p-6">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Leader
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Zone
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Contact
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Cell Day
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Submissions
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Status
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody id="leadersBody" class="divide-y divide-gray-200">
        <!-- Leaders will be loaded by JavaScript -->
      </tbody>
    </table>
  </div>

  <div id="noLeaders" class="hidden text-center py-8 text-gray-500">
    <i class="fas fa-users text-4xl mb-4"></i>
    <p>No leaders found. Add your first leader to get started!</p>
  </div>
</div>

<!-- Add/Edit Leader Modal -->
<div
  id="leaderModal"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50"
>
  <div
    class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-90vh overflow-y-auto"
  >
    <div class="p-6">
      <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-4">
        Add New Leader
      </h3>

      <form id="leaderForm" class="space-y-4">
        <input type="hidden" id="leaderId" />

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Full Name *</label
          >
          <input
            type="text"
            id="leaderName"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Zone *</label
          >
          <select
            id="leaderZone"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="">Select Zone</option>
            <!-- Zones will be populated by JavaScript -->
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Cell Day</label
          >
          <select
            id="leaderCellDay"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday" selected>Thursday</option>
            <option value="Friday">Friday</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Contact Number</label
          >
          <input
            type="tel"
            id="leaderContact"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="+27 XXX XXX XXXX"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Email Address</label
          >
          <input
            type="email"
            id="leaderEmail"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="leader@church.org.za"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Address</label
          >
          <textarea
            id="leaderAddress"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Full physical address"
          ></textarea>
        </div>

        <div class="flex items-center">
          <input
            type="checkbox"
            id="leaderActive"
            checked
            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <label for="leaderActive" class="ml-2 text-sm text-gray-700"
            >Active Leader</label
          >
        </div>

        <div class="flex space-x-3 pt-4">
          <button
            type="button"
            onclick="hideLeaderModal()"
            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            Save Leader
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Profile Picture Upload Modal -->
<div
  id="pictureModal"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50"
>
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">
        Upload Profile Picture
      </h3>

      <form id="pictureForm" class="space-y-4">
        <input type="hidden" id="pictureLeaderId" />

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Select Image
          </label>
          <input
            type="file"
            id="profilePicture"
            accept="image/*"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg"
            required
          />
          <p class="text-xs text-gray-500 mt-1">
            Maximum file size: 2MB. Allowed: JPG, PNG, GIF
          </p>
        </div>

        <div id="currentPicture" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Current Picture
          </label>
          <div class="flex items-center space-x-4">
            <img
              id="currentPictureImg"
              class="h-16 w-16 rounded-full object-cover"
              src=""
              alt="Current"
            />
            <button
              type="button"
              onclick="removeProfilePicture()"
              class="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200"
            >
              Remove
            </button>
          </div>
        </div>

        <div class="flex space-x-3 pt-4">
          <button
            type="button"
            onclick="hidePictureModal()"
            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
          >
            Upload Picture
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Profile Picture Viewer Modal -->
<div
  id="pictureViewerModal"
  class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
>
  <div
    class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-90vh overflow-hidden"
  >
    <div class="flex justify-between items-center p-4 border-b">
      <h3 class="text-lg font-semibold text-gray-800" id="viewerTitle">
        Profile Picture
      </h3>
      <button
        onclick="hidePictureViewer()"
        class="text-gray-500 hover:text-gray-700"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <div class="p-6 flex flex-col items-center justify-center">
      <!-- Large Profile Picture -->
      <div class="mb-4">
        <img
          id="enlargedProfilePicture"
          class="max-w-full max-h-96 rounded-lg shadow-lg object-contain"
          src=""
          alt="Enlarged Profile Picture"
        />
      </div>

      <!-- Leader Info -->
      <div class="text-center" id="viewerLeaderInfo">
        <h4
          class="text-xl font-semibold text-gray-800"
          id="viewerLeaderName"
        ></h4>
        <p class="text-gray-600" id="viewerLeaderZone"></p>
      </div>

      <!-- Action Buttons -->
      <div class="mt-6 flex space-x-4" id="viewerActions">
        <button
          onclick="downloadProfilePicture()"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center"
        >
          <i class="fas fa-download mr-2"></i>
          Download
        </button>
        <button
          onclick="showUploadPictureModalFromViewer()"
          class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center"
        >
          <i class="fas fa-camera mr-2"></i>
          Change Picture
        </button>
        <button
          onclick="removeProfilePictureFromViewer()"
          class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center"
        >
          <i class="fas fa-trash mr-2"></i>
          Remove
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backup & Restore Section -->
<div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
  <h3 class="text-lg font-semibold text-yellow-800 mb-4 flex items-center">
    <i class="fas fa-database mr-2"></i>
    Data Management
  </h3>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Backup -->
    <div class="text-center">
      <h4 class="font-medium text-yellow-700 mb-2">Backup Data</h4>
      <p class="text-sm text-yellow-600 mb-3">Download all data as JSON file</p>
      <a
        href="/api/backup-data"
        class="inline-flex items-center px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors"
      >
        <i class="fas fa-download mr-2"></i>
        Download Backup
      </a>
    </div>

    <!-- Restore -->
    <div class="text-center">
      <h4 class="font-medium text-yellow-700 mb-2">Restore Data</h4>
      <p class="text-sm text-yellow-600 mb-3">Upload JSON backup file</p>
      <form id="restoreForm" class="flex flex-col items-center">
        <input
          type="file"
          id="backupFile"
          accept=".json"
          class="mb-3 text-sm text-yellow-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-yellow-500 file:text-white hover:file:bg-yellow-600"
        />
        <button
          type="submit"
          class="inline-flex items-center px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors"
        >
          <i class="fas fa-upload mr-2"></i>
          Restore Backup
        </button>
      </form>
    </div>
  </div>

  <div class="mt-4 text-xs text-yellow-600 text-center">
    <i class="fas fa-info-circle mr-1"></i>
    Regular backups protect against data loss. Download monthly.
  </div>
</div>

<!-- Success/Error Messages -->
<div
  id="successMessage"
  class="hidden fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg"
>
  <div class="flex items-center">
    <i class="fas fa-check-circle mr-2"></i>
    <span id="successText">Operation completed successfully!</span>
  </div>
</div>

<div
  id="errorMessage"
  class="hidden fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg"
>
  <div class="flex items-center">
    <i class="fas fa-exclamation-circle mr-2"></i>
    <span id="errorText">Error performing operation</span>
  </div>
</div>

<script>
  // DOM Elements
  const leadersBody = document.getElementById("leadersBody");
  const noLeaders = document.getElementById("noLeaders");
  const leaderModal = document.getElementById("leaderModal");
  const modalTitle = document.getElementById("modalTitle");
  const leaderForm = document.getElementById("leaderForm");
  const zoneFilter = document.getElementById("zoneFilter");
  const leaderZone = document.getElementById("leaderZone");

  // Global variables for picture viewer
  let currentViewerLeaderId = null;
  let currentViewerLeaderName = null;
  let currentViewerLeaderZone = null;

  // Initialize page
  document.addEventListener("DOMContentLoaded", function () {
    loadZones();
    loadLeaders();
  });

  // Load available zones
  async function loadZones() {
    try {
      const response = await fetch("/api/zones");
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const zones = await response.json();

      // Populate zone filter
      zoneFilter.innerHTML =
        '<option value="">All Zones</option>' +
        zones
          .map((zone) => `<option value="${zone}">${zone}</option>`)
          .join("");

      // Populate zone dropdown in modal
      leaderZone.innerHTML =
        '<option value="">Select Zone</option>' +
        zones
          .map((zone) => `<option value="${zone}">${zone}</option>`)
          .join("");
    } catch (error) {
      console.error("Error loading zones:", error);
      // Fallback to hardcoded zones
      // Fallback to your zones
      const fallbackZones = ["Chestnut", "KB South", "KB North"];

      zoneFilter.innerHTML =
        '<option value="">All Zones</option>' +
        fallbackZones
          .map((zone) => `<option value="${zone}">${zone}</option>`)
          .join("");

      leaderZone.innerHTML =
        '<option value="">Select Zone</option>' +
        fallbackZones
          .map((zone) => `<option value="${zone}">${zone}</option>`)
          .join("");

      showError("Could not load zones. Using default list.");
    }
  }

  // Load leaders list
  async function loadLeaders() {
    try {
      const zone = zoneFilter.value;
      const params = zone ? `?zone=${encodeURIComponent(zone)}` : "";

      const response = await fetch(`/api/leaders${params}`);

      // Check if response is JSON
      const contentType = response.headers.get("content-type");
      if (!contentType || !contentType.includes("application/json")) {
        const text = await response.text();
        console.error("Received non-JSON response:", text.substring(0, 500));
        throw new Error("Server returned non-JSON response");
      }

      const leaders = await response.json();

      if (leaders.length === 0) {
        leadersBody.innerHTML = "";
        noLeaders.classList.remove("hidden");
        return;
      }

      noLeaders.classList.add("hidden");

      leadersBody.innerHTML = leaders
        .map(
          (leader) => `
              <tr class="hover:bg-gray-50 ${
                leader.is_active ? "" : "bg-gray-100"
              }">
                  <td class="px-4 py-3">
                      <div class="flex items-center">
                          <div class="flex-shrink-0 h-10 w-10">
                              ${
                                leader.profile_picture_url
                                  ? `<img class="h-10 w-10 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity"
                                       src="${leader.profile_picture_url}"
                                       alt="${leader.name}"
                                       onclick="showEnlargedProfilePicture(${
                                         leader.id
                                       }, '${leader.name.replace(
                                      /'/g,
                                      "\\'"
                                    )}', '${leader.zone}', '${
                                      leader.profile_picture_url
                                    }')">`
                                  : `<div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center cursor-pointer hover:bg-blue-200 transition-colors"
                                       onclick="showEnlargedProfilePicture(${
                                         leader.id
                                       }, '${leader.name.replace(
                                      /'/g,
                                      "\\'"
                                    )}', '${leader.zone}', null)">
                                    <span class="text-blue-600 font-medium">${
                                      leader.initials || "LG"
                                    }</span>
                                  </div>`
                              }
                          </div>
                          <div class="ml-4">
                              <div class="font-medium text-gray-900">${
                                leader.name
                              }</div>
                              <div class="text-sm text-gray-500">${
                                leader.email || "No email"
                              }</div>
                          </div>
                      </div>
                  </td>
                  <td class="px-4 py-3 text-gray-900">${leader.zone}</td>
                  <td class="px-4 py-3">
                      <div class="text-sm text-gray-900">${
                        leader.contact_number || "No contact"
                      }</div>
                      <div class="text-xs text-gray-500 truncate max-w-xs">${
                        leader.address || "No address"
                      }</div>
                  </td>
                  <td class="px-4 py-3 text-gray-900">${leader.cell_day}</td>
                  <td class="px-4 py-3">
                      <div class="text-sm text-gray-900">${
                        leader.total_submissions
                      } submissions</div>
                      <div class="text-xs text-gray-500">Last: ${
                        leader.last_submission
                      }</div>
                  </td>
                  <td class="px-4 py-3">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        leader.is_active
                          ? "bg-green-100 text-green-800"
                          : "bg-red-100 text-red-800"
                      }">
                          ${leader.is_active ? "Active" : "Inactive"}
                      </span>
                  </td>
                  <td class="px-4 py-3">
                      <div class="flex space-x-2">
                          <button onclick="editLeader(${
                            leader.id
                          })" class="text-blue-600 hover:text-blue-800" title="Edit">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button onclick="toggleLeaderStatus(${
                            leader.id
                          }, ${!leader.is_active})" class="${
            leader.is_active
              ? "text-orange-600 hover:text-orange-800"
              : "text-green-600 hover:text-green-800"
          }" title="${leader.is_active ? "Deactivate" : "Activate"}">
                              <i class="fas ${
                                leader.is_active ? "fa-pause" : "fa-play"
                              }"></i>
                          </button>
                          <button onclick="deleteLeader(${
                            leader.id
                          })" class="text-red-600 hover:text-red-800" title="Delete">
                              <i class="fas fa-trash"></i>
                          </button>
                          <button onclick="showUploadPictureModal(${
                            leader.id
                          })" class="text-purple-600 hover:text-purple-800" title="Upload Picture">
                              <i class="fas fa-camera"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `
        )
        .join("");
    } catch (error) {
      console.error("Error loading leaders:", error);
      showError("Error loading leaders list. Check console for details.");
    }
  }

  // Show add leader form
  function showAddLeaderForm() {
    modalTitle.textContent = "Add New Leader";
    leaderForm.reset();
    document.getElementById("leaderId").value = "";
    document.getElementById("leaderActive").checked = true;
    leaderModal.classList.remove("hidden");
  }

  // Edit leader
  async function editLeader(leaderId) {
    try {
      const response = await fetch(`/api/leader/${leaderId}`);
      const leader = await response.json();

      modalTitle.textContent = "Edit Leader";
      document.getElementById("leaderId").value = leader.id;
      document.getElementById("leaderName").value = leader.name;
      document.getElementById("leaderZone").value = leader.zone;
      document.getElementById("leaderCellDay").value = leader.cell_day;
      document.getElementById("leaderContact").value =
        leader.contact_number || "";
      document.getElementById("leaderEmail").value = leader.email || "";
      document.getElementById("leaderAddress").value = leader.address || "";
      document.getElementById("leaderActive").checked = leader.is_active;

      leaderModal.classList.remove("hidden");
    } catch (error) {
      console.error("Error loading leader:", error);
      showError("Error loading leader details");
    }
  }

  // Hide leader modal
  function hideLeaderModal() {
    leaderModal.classList.add("hidden");
  }

  // Delete a leader
  async function deleteLeader(leaderId) {
    if (
      !confirm(
        "Are you sure you want to delete this leader? This action cannot be undone."
      )
    ) {
      return;
    }

    try {
      const response = await fetch(`/api/leader/${leaderId}/delete`, {
        method: "DELETE",
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        showSuccess("Leader deleted successfully!");
        loadLeaders(); // Refresh the list
      } else {
        showError(result.message || "Failed to delete leader");
      }
    } catch (error) {
      console.error("Error deleting leader:", error);
      showError("Error deleting leader. Check console for details.");
    }
  }

  // Toggle leader status
  async function toggleLeaderStatus(leaderId, newStatus) {
    try {
      const response = await fetch(`/api/leader/${leaderId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          is_active: newStatus,
        }),
      });

      const result = await response.json();

      if (result.success) {
        showSuccess(
          `Leader ${newStatus ? "activated" : "deactivated"} successfully!`
        );
        loadLeaders();
      } else {
        showError(result.message);
      }
    } catch (error) {
      console.error("Error toggling leader status:", error);
      showError("Error updating leader status");
    }
  }

  // Show upload picture modal
  async function showUploadPictureModal(leaderId) {
    document.getElementById("pictureLeaderId").value = leaderId;

    // Check if leader has existing picture
    try {
      const response = await fetch(`/api/leader/${leaderId}`);
      const leader = await response.json();

      const currentPictureDiv = document.getElementById("currentPicture");
      const currentPictureImg = document.getElementById("currentPictureImg");

      if (leader.profile_picture_url) {
        currentPictureImg.src = leader.profile_picture_url;
        currentPictureDiv.classList.remove("hidden");
      } else {
        currentPictureDiv.classList.add("hidden");
      }
    } catch (error) {
      console.error("Error loading leader picture:", error);
      document.getElementById("currentPicture").classList.add("hidden");
    }

    document.getElementById("pictureModal").classList.remove("hidden");
  }

  // Hide picture modal
  function hidePictureModal() {
    document.getElementById("pictureModal").classList.add("hidden");
    document.getElementById("pictureForm").reset();
  }

  // Remove profile picture
  async function removeProfilePicture() {
    const leaderId = document.getElementById("pictureLeaderId").value;

    if (!confirm("Remove profile picture?")) {
      return;
    }

    try {
      const response = await fetch(`/api/leader/${leaderId}/remove-picture`, {
        method: "POST",
      });

      const result = await response.json();

      if (result.success) {
        showSuccess("Profile picture removed!");
        document.getElementById("currentPicture").classList.add("hidden");
        loadLeaders(); // Refresh the list
      } else {
        showError(result.message);
      }
    } catch (error) {
      console.error("Error removing picture:", error);
      showError("Error removing picture");
    }
  }

  // Show enlarged profile picture with loading indicator
  function showEnlargedProfilePicture(
    leaderId,
    leaderName,
    leaderZone,
    pictureUrl
  ) {
    currentViewerLeaderId = leaderId;
    currentViewerLeaderName = leaderName;
    currentViewerLeaderZone = leaderZone;

    const enlargedImg = document.getElementById("enlargedProfilePicture");
    const leaderNameEl = document.getElementById("viewerLeaderName");
    const leaderZoneEl = document.getElementById("viewerLeaderZone");
    const viewerActions = document.getElementById("viewerActions");

    // Show loading state
    enlargedImg.classList.add("opacity-0");
    viewerActions.classList.add("opacity-50", "pointer-events-none");

    // Set the image
    if (pictureUrl) {
      enlargedImg.src = pictureUrl;
      enlargedImg.onload = function () {
        enlargedImg.classList.remove("opacity-0");
        viewerActions.classList.remove("opacity-50", "pointer-events-none");
        enlargedImg.classList.remove("hidden");
      };
      enlargedImg.onerror = function () {
        enlargedImg.classList.add("hidden");
        viewerActions.classList.remove("opacity-50", "pointer-events-none");
        showError("Failed to load image");
      };
    } else {
      enlargedImg.classList.add("hidden");
      viewerActions.classList.remove("opacity-50", "pointer-events-none");
    }

    // Set leader info
    leaderNameEl.textContent = leaderName;
    leaderZoneEl.textContent = leaderZone;

    // Show the modal
    document.getElementById("pictureViewerModal").classList.remove("hidden");
  }

  // Hide picture viewer
  function hidePictureViewer() {
    document.getElementById("pictureViewerModal").classList.add("hidden");
    currentViewerLeaderId = null;
    currentViewerLeaderName = null;
    currentViewerLeaderZone = null;
  }

  // Download profile picture
  function downloadProfilePicture() {
    const img = document.getElementById("enlargedProfilePicture");
    if (img.src && !img.classList.contains("hidden")) {
      const link = document.createElement("a");
      link.href = img.src;
      link.download = `profile_${currentViewerLeaderName.replace(
        /\s+/g,
        "_"
      )}.jpg`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showSuccess("Profile picture download started!");
    } else {
      showError("No profile picture to download");
    }
  }

  // Show upload modal from viewer
  function showUploadPictureModalFromViewer() {
    hidePictureViewer();
    if (currentViewerLeaderId) {
      showUploadPictureModal(currentViewerLeaderId);
    }
  }

  // Remove picture from viewer
  async function removeProfilePictureFromViewer() {
    if (!currentViewerLeaderId) return;

    if (!confirm("Remove this profile picture?")) {
      return;
    }

    try {
      const response = await fetch(
        `/api/leader/${currentViewerLeaderId}/remove-picture`,
        {
          method: "POST",
        }
      );

      const result = await response.json();

      if (result.success) {
        showSuccess("Profile picture removed!");
        hidePictureViewer();
        loadLeaders(); // Refresh the list
      } else {
        showError(result.message);
      }
    } catch (error) {
      console.error("Error removing picture:", error);
      showError("Error removing picture");
    }
  }

  // Handle picture form submission
  document
    .getElementById("pictureForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const leaderId = document.getElementById("pictureLeaderId").value;
      const fileInput = document.getElementById("profilePicture");
      const file = fileInput.files[0];

      if (!file) {
        showError("Please select a file");
        return;
      }

      const formData = new FormData();
      formData.append("profile_picture", file);

      try {
        const response = await fetch(`/api/leader/${leaderId}/upload-picture`, {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          showSuccess("Profile picture uploaded!");
          hidePictureModal();
          loadLeaders(); // Refresh the list
        } else {
          showError(result.message);
        }
      } catch (error) {
        console.error("Error uploading picture:", error);
        showError("Error uploading picture");
      }
    });

  // Handle form submission
  leaderForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    const leaderId = document.getElementById("leaderId").value;
    const formData = {
      name: document.getElementById("leaderName").value,
      zone: document.getElementById("leaderZone").value,
      cell_day: document.getElementById("leaderCellDay").value,
      contact_number: document.getElementById("leaderContact").value,
      email: document.getElementById("leaderEmail").value,
      address: document.getElementById("leaderAddress").value,
      is_active: document.getElementById("leaderActive").checked,
    };

    try {
      const url = leaderId ? `/api/leader/${leaderId}` : "/api/leader";
      const method = leaderId ? "PUT" : "POST";

      const response = await fetch(url, {
        method: method,
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      const result = await response.json();

      if (result.success) {
        showSuccess(
          leaderId
            ? "Leader updated successfully!"
            : "Leader created successfully!"
        );
        hideLeaderModal();
        loadLeaders();
        loadZones(); // Refresh zones in case new zone was added
      } else {
        showError(result.message);
      }
    } catch (error) {
      console.error("Error saving leader:", error);
      showError("Error saving leader");
    }
  });

  // Show success message
  function showSuccess(message) {
    document.getElementById("successText").textContent = message;
    document.getElementById("successMessage").classList.remove("hidden");
    setTimeout(() => {
      document.getElementById("successMessage").classList.add("hidden");
    }, 5000);
  }

  // Show error message
  function showError(message) {
    document.getElementById("errorText").textContent = message;
    document.getElementById("errorMessage").classList.remove("hidden");
    setTimeout(() => {
      document.getElementById("errorMessage").classList.add("hidden");
    }, 5000);
  }

  // Close modal when clicking outside
  leaderModal.addEventListener("click", function (e) {
    if (e.target === leaderModal) {
      hideLeaderModal();
    }
  });

  // Close picture modal when clicking outside
  document
    .getElementById("pictureModal")
    .addEventListener("click", function (e) {
      if (e.target === this) {
        hidePictureModal();
      }
    });

  // Close viewer when clicking outside
  document
    .getElementById("pictureViewerModal")
    .addEventListener("click", function (e) {
      if (e.target === this) {
        hidePictureViewer();
      }
    });

  // Keyboard shortcuts for modal
  document.addEventListener("keydown", function (e) {
    const viewerModal = document.getElementById("pictureViewerModal");

    if (!viewerModal.classList.contains("hidden")) {
      // Escape key to close
      if (e.key === "Escape") {
        hidePictureViewer();
      }
    }
  });
</script>

<style>
  .max-h-90vh {
    max-height: 90vh;
  }

  /* Animation for modal */
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  #pictureViewerModal > div {
    animation: slideIn 0.3s ease-out;
  }

  #pictureViewerModal {
    animation: fadeIn 0.2s ease-out;
  }

  /* Hover effects for profile pictures */
  img[class*="rounded-full"] {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  img[class*="rounded-full"]:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  /* Loading state for image */
  #enlargedProfilePicture {
    min-height: 200px;
    min-width: 200px;
    background: linear-gradient(
      45deg,
      #f3f4f6 25%,
      #e5e7eb 25%,
      #e5e7eb 50%,
      #f3f4f6 50%,
      #f3f4f6 75%,
      #e5e7eb 75%
    );
    background-size: 40px 40px;
    transition: opacity 0.3s ease;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    #pictureViewerModal > div {
      max-width: 95%;
      margin: 1rem;
    }

    #viewerActions {
      flex-direction: column;
      gap: 0.5rem;
    }

    #viewerActions button {
      width: 100%;
    }
    /* Update button colors in leaders_management.html */
    button.bg-blue-600 {
      background-color: #0d9488;
    }
    button.bg-blue-600:hover {
      background-color: #0f766e;
    }

    button.bg-green-600 {
      background-color: #059669;
    }
    button.bg-green-600:hover {
      background-color: #047857;
    }

    button.bg-purple-600 {
      background-color: #0d9488;
    }
    button.bg-purple-600:hover {
      background-color: #0f766e;
    }

    button.bg-red-600 {
      background-color: #dc2626;
    }
    button.bg-red-600:hover {
      background-color: #b91c1c;
    }

    button.bg-orange-600 {
      background-color: #ea580c;
    }
    button.bg-orange-600:hover {
      background-color: #c2410c;
    }

    button.bg-yellow-600 {
      background-color: #ca8a04;
    }
    button.bg-yellow-600:hover {
      background-color: #a16207;
    }

    /* Update badges */
    .bg-green-100 {
      background-color: #d1fae5;
    }
    .text-green-800 {
      color: #065f46;
    }

    .bg-red-100 {
      background-color: #fee2e2;
    }
    .text-red-800 {
      color: #991b1b;
    }

    /* Update profile picture initials */
    .bg-blue-100 {
      background-color: #dbeafe;
    }
    .text-blue-600 {
      color: #2563eb;
    }

    /* Update table styles */
    .bg-gray-50 {
      background-color: #f9fafb;
    }
    .text-gray-500 {
      color: #6b7280;
    }
    .text-gray-700 {
      color: #374151;
    }
    .text-gray-800 {
      color: #1f2937;
    }
    .text-gray-900 {
      color: #111827;
    }

    /* Update borders */
    .border-gray-200 {
      border-color: #e5e7eb;
    }
    .border-gray-300 {
      border-color: #d1d5db;
    }

    /* Update focus rings */
    .focus\:ring-blue-500:focus {
      --tw-ring-color: #0d9488;
    }

    /* Update card backgrounds */
    .bg-white {
      background-color: #ffffff;
    }
    .bg-yellow-50 {
      background-color: #fffbeb;
    }
    .border-yellow-200 {
      border-color: #fde68a;
    }
    .text-yellow-800 {
      color: #92400e;
    }
  }
</style>
{% endblock %}
