{% extends "base.html" %} {% block content %}
<!-- Header -->
<div class="text-center mb-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-2">Leaders Management</h1>
  <p class="text-gray-600">
    Manage cell group leaders and their contact information
  </p>
</div>

<!-- Add Leader Button -->
<div class="mb-6 flex justify-between items-center">
  <div class="flex space-x-4">
    <button
      onclick="showAddLeaderForm()"
      class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center"
    >
      <i class="fas fa-plus mr-2"></i>
      Add New Leader
    </button>
    <button
      onclick="loadLeaders()"
      class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center"
    >
      <i class="fas fa-refresh mr-2"></i>
      Refresh
    </button>
  </div>

  <!-- Zone Filter -->
  <div>
    <select
      id="zoneFilter"
      onchange="loadLeaders()"
      class="px-4 py-2 border border-gray-300 rounded-lg"
    >
      <option value="">All Zones</option>
      <!-- Zones will be populated by JavaScript -->
    </select>
  </div>
</div>

<!-- Leaders Table -->
<div class="bg-white rounded-lg shadow-md p-6">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Leader
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Zone
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Contact
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Cell Day
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Submissions
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Status
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody id="leadersBody" class="divide-y divide-gray-200">
        <!-- Leaders will be loaded by JavaScript -->
      </tbody>
    </table>
  </div>

  <div id="noLeaders" class="hidden text-center py-8 text-gray-500">
    <i class="fas fa-users text-4xl mb-4"></i>
    <p>No leaders found. Add your first leader to get started!</p>
  </div>
</div>

<!-- Add/Edit Leader Modal -->
<div
  id="leaderModal"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50"
>
  <div
    class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-90vh overflow-y-auto"
  >
    <div class="p-6">
      <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-4">
        Add New Leader
      </h3>

      <form id="leaderForm" class="space-y-4">
        <input type="hidden" id="leaderId" />

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Full Name *</label
          >
          <input
            type="text"
            id="leaderName"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Zone *</label
          >
          <select
            id="leaderZone"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="">Select Zone</option>
            <!-- Zones will be populated by JavaScript -->
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Cell Day</label
          >
          <select
            id="leaderCellDay"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday" selected>Thursday</option>
            <option value="Friday">Friday</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Contact Number</label
          >
          <input
            type="tel"
            id="leaderContact"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="+27 XXX XXX XXXX"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Email Address</label
          >
          <input
            type="email"
            id="leaderEmail"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="leader@church.org.za"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Address</label
          >
          <textarea
            id="leaderAddress"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Full physical address"
          ></textarea>
        </div>

        <div class="flex items-center">
          <input
            type="checkbox"
            id="leaderActive"
            checked
            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <label for="leaderActive" class="ml-2 text-sm text-gray-700"
            >Active Leader</label
          >
        </div>

        <div class="flex space-x-3 pt-4">
          <button
            type="button"
            onclick="hideLeaderModal()"
            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            Save Leader
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Success/Error Messages -->
<div
  id="successMessage"
  class="hidden fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg"
>
  <div class="flex items-center">
    <i class="fas fa-check-circle mr-2"></i>
    <span id="successText">Operation completed successfully!</span>
  </div>
</div>

<div
  id="errorMessage"
  class="hidden fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg"
>
  <div class="flex items-center">
    <i class="fas fa-exclamation-circle mr-2"></i>
    <span id="errorText">Error performing operation</span>
  </div>
</div>

<script>
  // DOM Elements
  const leadersBody = document.getElementById("leadersBody");
  const noLeaders = document.getElementById("noLeaders");
  const leaderModal = document.getElementById("leaderModal");
  const modalTitle = document.getElementById("modalTitle");
  const leaderForm = document.getElementById("leaderForm");
  const zoneFilter = document.getElementById("zoneFilter");
  const leaderZone = document.getElementById("leaderZone");

  // Initialize page
  document.addEventListener("DOMContentLoaded", function () {
    loadZones();
    loadLeaders();
  });

  // Load available zones
  async function loadZones() {
    try {
      const response = await fetch("/api/leaders?active_only=true");
      const leaders = await response.json();

      const zones = [...new Set(leaders.map((leader) => leader.zone))].sort();

      // Populate zone filter
      zoneFilter.innerHTML =
        '<option value="">All Zones</option>' +
        zones
          .map((zone) => `<option value="${zone}">${zone}</option>`)
          .join("");

      // Populate zone dropdown in modal
      leaderZone.innerHTML =
        '<option value="">Select Zone</option>' +
        zones
          .map((zone) => `<option value="${zone}">${zone}</option>`)
          .join("");
    } catch (error) {
      console.error("Error loading zones:", error);
    }
  }

  // Load leaders list
  async function loadLeaders() {
    try {
      const zone = zoneFilter.value;
      const params = zone ? `?zone=${encodeURIComponent(zone)}` : "";

      const response = await fetch(`/api/leaders${params}`);
      const leaders = await response.json();

      if (leaders.length === 0) {
        leadersBody.innerHTML = "";
        noLeaders.classList.remove("hidden");
        return;
      }

      noLeaders.classList.add("hidden");

      leadersBody.innerHTML = leaders
        .map(
          (leader) => `
            <tr class="hover:bg-gray-50 ${
              leader.is_active ? "" : "bg-gray-100"
            }">
                <td class="px-4 py-3">
                    <div class="font-medium text-gray-900">${leader.name}</div>
                    <div class="text-sm text-gray-500">${
                      leader.email || "No email"
                    }</div>
                </td>
                <td class="px-4 py-3 text-gray-900">${leader.zone}</td>
                <td class="px-4 py-3">
                    <div class="text-sm text-gray-900">${
                      leader.contact_number || "No contact"
                    }</div>
                    <div class="text-xs text-gray-500 truncate max-w-xs">${
                      leader.address || "No address"
                    }</div>
                </td>
                <td class="px-4 py-3 text-gray-900">${leader.cell_day}</td>
                <td class="px-4 py-3">
                    <div class="text-sm text-gray-900">${
                      leader.total_submissions
                    } submissions</div>
                    <div class="text-xs text-gray-500">Last: ${
                      leader.last_submission
                    }</div>
                </td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      leader.is_active
                        ? "bg-green-100 text-green-800"
                        : "bg-red-100 text-red-800"
                    }">
                        ${leader.is_active ? "Active" : "Inactive"}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="flex space-x-2">
                        <button onclick="editLeader(${
                          leader.id
                        })" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="toggleLeaderStatus(${
                          leader.id
                        }, ${!leader.is_active})" class="${
            leader.is_active
              ? "text-orange-600 hover:text-orange-800"
              : "text-green-600 hover:text-green-800"
          }">
                            <i class="fas ${
                              leader.is_active ? "fa-pause" : "fa-play"
                            }"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `
        )
        .join("");
    } catch (error) {
      console.error("Error loading leaders:", error);
      showError("Error loading leaders list");
    }
  }

  // Show add leader form
  function showAddLeaderForm() {
    modalTitle.textContent = "Add New Leader";
    leaderForm.reset();
    document.getElementById("leaderId").value = "";
    document.getElementById("leaderActive").checked = true;
    leaderModal.classList.remove("hidden");
  }

  // Edit leader
  async function editLeader(leaderId) {
    try {
      const response = await fetch(`/api/leader/${leaderId}`);
      const leader = await response.json();

      modalTitle.textContent = "Edit Leader";
      document.getElementById("leaderId").value = leader.id;
      document.getElementById("leaderName").value = leader.name;
      document.getElementById("leaderZone").value = leader.zone;
      document.getElementById("leaderCellDay").value = leader.cell_day;
      document.getElementById("leaderContact").value =
        leader.contact_number || "";
      document.getElementById("leaderEmail").value = leader.email || "";
      document.getElementById("leaderAddress").value = leader.address || "";
      document.getElementById("leaderActive").checked = leader.is_active;

      leaderModal.classList.remove("hidden");
    } catch (error) {
      console.error("Error loading leader:", error);
      showError("Error loading leader details");
    }
  }

  // Hide leader modal
  function hideLeaderModal() {
    leaderModal.classList.add("hidden");
  }

  // Toggle leader status
  async function toggleLeaderStatus(leaderId, newStatus) {
    try {
      const response = await fetch(`/api/leader/${leaderId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          is_active: newStatus,
        }),
      });

      const result = await response.json();

      if (result.success) {
        showSuccess(
          `Leader ${newStatus ? "activated" : "deactivated"} successfully!`
        );
        loadLeaders();
      } else {
        showError(result.message);
      }
    } catch (error) {
      console.error("Error toggling leader status:", error);
      showError("Error updating leader status");
    }
  }

  // Handle form submission
  leaderForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    const leaderId = document.getElementById("leaderId").value;
    const formData = {
      name: document.getElementById("leaderName").value,
      zone: document.getElementById("leaderZone").value,
      cell_day: document.getElementById("leaderCellDay").value,
      contact_number: document.getElementById("leaderContact").value,
      email: document.getElementById("leaderEmail").value,
      address: document.getElementById("leaderAddress").value,
      is_active: document.getElementById("leaderActive").checked,
    };

    try {
      const url = leaderId ? `/api/leader/${leaderId}` : "/api/leader";
      const method = leaderId ? "PUT" : "POST";

      const response = await fetch(url, {
        method: method,
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      const result = await response.json();

      if (result.success) {
        showSuccess(
          leaderId
            ? "Leader updated successfully!"
            : "Leader created successfully!"
        );
        hideLeaderModal();
        loadLeaders();
        loadZones(); // Refresh zones in case new zone was added
      } else {
        showError(result.message);
      }
    } catch (error) {
      console.error("Error saving leader:", error);
      showError("Error saving leader");
    }
  });

  // Show success message
  function showSuccess(message) {
    document.getElementById("successText").textContent = message;
    document.getElementById("successMessage").classList.remove("hidden");
    setTimeout(() => {
      document.getElementById("successMessage").classList.add("hidden");
    }, 5000);
  }

  // Show error message
  function showError(message) {
    document.getElementById("errorText").textContent = message;
    document.getElementById("errorMessage").classList.remove("hidden");
    setTimeout(() => {
      document.getElementById("errorMessage").classList.add("hidden");
    }, 5000);
  }

  // Close modal when clicking outside
  leaderModal.addEventListener("click", function (e) {
    if (e.target === leaderModal) {
      hideLeaderModal();
    }
  });
</script>

<style>
  .max-h-90vh {
    max-height: 90vh;
  }
</style>
{% endblock %}
