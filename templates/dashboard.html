{% extends "base.html" %}

{% block content %}
<!-- Header -->
<div class="text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Church Analytics Dashboard</h1>
    <p class="text-gray-600">Comprehensive view of cell group performance and growth metrics</p>
</div>

<!-- Filters Card -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Time Period Filter -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
            <select id="periodFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
            </select>
        </div>

        <!-- Zone Filter -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Zone</label>
            <select id="zoneFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">All Zones</option>
                <!-- Zones will be populated by JavaScript -->
            </select>
        </div>

        <!-- Leader Filter -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Leader</label>
            <select id="leaderFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">All Leaders</option>
                <!-- Leaders will be populated by JavaScript -->
            </select>
        </div>

        <!-- Refresh Button -->
        <div class="flex items-end">
            <button
                onclick="loadAnalytics()"
                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
            >
                <i class="fas fa-refresh mr-2"></i>
                Refresh Data
            </button>
        </div>
    </div>
</div>

<!-- Stats Overview -->
<div id="statsOverview" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
    <!-- Stats will be loaded by JavaScript -->
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Attendance Trends Chart -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Attendance Trends</h3>
        <div class="h-64">
            <canvas id="attendanceChart"></canvas>
        </div>
    </div>

    <!-- Service Type Distribution -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Service Distribution</h3>
        <div class="h-64">
            <canvas id="serviceTypeChart"></canvas>
        </div>
    </div>
</div>

<!-- Zone Performance -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Zone Performance</h3>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zone</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Services</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Attendance</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Visitors</th>
                    <th class="px-4py-3 text-left text-xs font-medium text-gray-500 uppercase">Offering (ZAR)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Decisions</th>
                </tr>
            </thead>
            <tbody id="zoneStatsBody" class="divide-y divide-gray-200">
                <!-- Zone stats will be loaded by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Leader Performance -->
<div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Leader Performance</h3>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Leader</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zone</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Services</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Attendance</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Visitors</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Offering (ZAR)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Decisions</th>
                </tr>
            </thead>
            <tbody id="leaderStatsBody" class="divide-y divide-gray-200">
                <!-- Leader stats will be loaded by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
        <i class="fas fa-spinner fa-spin text-blue-600 mr-3"></i>
        <span>Loading analytics data...</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart instances
let attendanceChart = null;
let serviceTypeChart = null;

// DOM Elements
const periodFilter = document.getElementById('periodFilter');
const zoneFilter = document.getElementById('zoneFilter');
const leaderFilter = document.getElementById('leaderFilter');
const statsOverview = document.getElementById('statsOverview');
const zoneStatsBody = document.getElementById('zoneStatsBody');
const leaderStatsBody = document.getElementById('leaderStatsBody');
const loadingSpinner = document.getElementById('loadingSpinner');

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadFilters();
    loadAnalytics();
});

// Load filter options
async function loadFilters() {
    try {
        // Load zones
        const zonesResponse = await fetch('/api/leaders?active_only=true');
        const leaders = await zonesResponse.json();

        const zones = [...new Set(leaders.map(leader => leader.zone))].sort();
        zoneFilter.innerHTML = '<option value="">All Zones</option>' +
            zones.map(zone => `<option value="${zone}">${zone}</option>`).join('');

        // Load leaders
        leaderFilter.innerHTML = '<option value="">All Leaders</option>' +
            leaders.map(leader => `<option value="${leader.id}">${leader.name}</option>`).join('');

    } catch (error) {
        console.error('Error loading filters:', error);
    }
}

// Load analytics data
async function loadAnalytics() {
    showLoading(true);

    try {
        const period = periodFilter.value;
        const zone = zoneFilter.value;
        const leaderId = leaderFilter.value;

        // Build query parameters
        const params = new URLSearchParams({ period });
        if (zone) params.append('zone', zone);
        if (leaderId) params.append('leader_id', leaderId);

        // Load overview data
        const overviewResponse = await fetch(`/api/analytics/overview?${params}`);
        const overviewData = await overviewResponse.json();

        // Load trends data
        const trendsResponse = await fetch(`/api/analytics/trends?${params}`);
        const trendsData = await trendsResponse.json();

        // Update UI
        updateStatsOverview(overviewData);
        updateZoneStats(overviewData.zone_stats);
        updateLeaderStats(overviewData.leader_stats);
        updateCharts(overviewData, trendsData);

    } catch (error) {
        console.error('Error loading analytics:', error);
        alert('Error loading analytics data. Please try again.');
    } finally {
        showLoading(false);
    }
}

// Update stats overview cards
function updateStatsOverview(data) {
    statsOverview.innerHTML = `
        <div class="bg-blue-50 p-6 rounded-lg text-center">
            <div class="text-3xl font-bold text-blue-600">${data.total_attendance}</div>
            <div class="text-sm text-blue-800 mt-1">Total Attendance</div>
            <div class="text-xs text-blue-600 mt-2">${data.start_date} to ${data.end_date}</div>
        </div>
        <div class="bg-green-50 p-6 rounded-lg text-center">
            <div class="text-3xl font-bold text-green-600">${data.total_visitors}</div>
            <div class="text-sm text-green-800 mt-1">Total Visitors</div>
            <div class="text-xs text-green-600 mt-2">Newcomers</div>
        </div>
        <div class="bg-purple-50 p-6 rounded-lg text-center">
            <div class="text-3xl font-bold text-purple-600">R${data.total_offering.toFixed(2)}</div>
            <div class="text-sm text-purple-800 mt-1">Total Offering</div>
            <div class="text-xs text-purple-600 mt-2">Cell Meetings Only</div>
        </div>
        <div class="bg-orange-50 p-6 rounded-lg text-center">
            <div class="text-3xl font-bold text-orange-600">${data.total_decisions}</div>
            <div class="text-sm text-orange-800 mt-1">Salvation Decisions</div>
            <div class="text-xs text-orange-600 mt-2">Lives Changed</div>
        </div>
    `;
}

// Update zone statistics table
function updateZoneStats(zoneStats) {
    if (Object.keys(zoneStats).length === 0) {
        zoneStatsBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No data available for selected filters</td></tr>';
        return;
    }

    zoneStatsBody.innerHTML = Object.entries(zoneStats)
        .sort(([,a], [,b]) => b.attendance - a.attendance)
        .map(([zone, stats]) => `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 font-medium text-gray-900">${zone}</td>
                <td class="px-4 py-3 text-gray-900">${stats.services}</td>
                <td class="px-4 py-3 text-gray-900">${stats.attendance}</td>
                <td class="px-4 py-3 text-gray-900">${stats.visitors}</td>
                <td class="px-4 py-3 text-gray-900">R${stats.offering.toFixed(2)}</td>
                <td class="px-4 py-3 text-gray-900">${stats.decisions}</td>
            </tr>
        `).join('');
}

// Update leader statistics table
function updateLeaderStats(leaderStats) {
    if (Object.keys(leaderStats).length === 0) {
        leaderStatsBody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No data available for selected filters</td></tr>';
        return;
    }

    leaderStatsBody.innerHTML = Object.entries(leaderStats)
        .sort(([,a], [,b]) => b.attendance - a.attendance)
        .map(([leader, stats]) => `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 font-medium text-gray-900">${leader}</td>
                <td class="px-4 py-3 text-gray-900">${stats.zone}</td>
                <td class="px-4 py-3 text-gray-900">${stats.services}</td>
                <td class="px-4 py-3 text-gray-900">${stats.attendance}</td>
                <td class="px-4 py-3 text-gray-900">${stats.visitors}</td>
                <td class="px-4 py-3 text-gray-900">R${stats.offering.toFixed(2)}</td>
                <td class="px-4 py-3 text-gray-900">${stats.decisions}</td>
            </tr>
        `).join('');
}

// Update charts
function updateCharts(overviewData, trendsData) {
    updateAttendanceChart(trendsData);
    updateServiceTypeChart(overviewData);
}

// Update attendance trends chart
function updateAttendanceChart(trendsData) {
    const ctx = document.getElementById('attendanceChart').getContext('2d');

    if (attendanceChart) {
        attendanceChart.destroy();
    }

    const labels = trendsData.map(item => item.date);
    const attendanceData = trendsData.map(item => item.attendance);
    const visitorsData = trendsData.map(item => item.visitors);

    attendanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Attendance',
                    data: attendanceData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Visitors',
                    data: visitorsData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of People'
                    }
                }
            }
        }
    });
}

// Update service type distribution chart
function updateServiceTypeChart(overviewData) {
    const ctx = document.getElementById('serviceTypeChart').getContext('2d');

    if (serviceTypeChart) {
        serviceTypeChart.destroy();
    }

    serviceTypeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Sunday Services', 'Cell Meetings'],
            datasets: [{
                data: [overviewData.sunday_services, overviewData.cell_meetings],
                backgroundColor: ['#3b82f6', '#10b981'],
                hoverBackgroundColor: ['#2563eb', '#059669']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((context.raw / total) * 100);
                            return `${context.label}: ${context.raw} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Show/hide loading spinner
function showLoading(show) {
    if (show) {
        loadingSpinner.classList.remove('hidden');
    } else {
        loadingSpinner.classList.add('hidden');
    }
}

// Event listeners for filters
periodFilter.addEventListener('change', loadAnalytics);
zoneFilter.addEventListener('change', loadAnalytics);
leaderFilter.addEventListener('change', loadAnalytics);
</script>
</style>
</style>
{% endblock %}
